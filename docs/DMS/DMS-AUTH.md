# Authorization in the Data Management Service

> [!TIP]
> Also see [Authentication and Authorization Requirements](../AUTH.md)

The Data Management Service will reproduce the authorization _strategies_ [employed by the Ed-Fi ODS / API](./AUTHORIZATION/ODS-API.md). The _mechanisms_, however, will necessarily differ due to the new database design and the decision to use JSON Web Tokens (JWT) instead of a random string bearer token.

> [!WARNING]
> This document does not yet address how to handle education organizations or relationship based authorization. It also does not describe an analogy to the new [extensible authorization filtering](https://docs.ed-fi.org/reference/ods-api/7.3/whats-new/whats-new-in-this-release#extensible-authorization-filtering) in ODS / API v7.3.

## Authorization Claims

The out of the box authorization strategies depend on one or more of the following pieces of information:

* education organization(s)
* namespaces
* resources (e.g. the things managed by the API)
* actions (create, read, update, delete, read changes)
* authorization strategies

Ideally, a JSON Web Token would encode all of the information needed to grant authorization for a client access request. But an Ed-Fi API needs too much information; storing it all in the JWT would create a very large token that would contribute to significant network traffic.

### ClaimSet and Scope

A pre-built combination of resources, actions, and authorization strategies is called a _claimset_ in Ed-Fi API systems. Also see [Claimset Management](../CS/CLAIMSET-MGMT.md). A given deployment typically has a small number of claimsets, with potentially many clients using the same claimset. The DMS will expect to find the claimset's unique name as a _scope_, which will be included in the JWT as a claim. For example, the JWT may contain `"scope": "SIS-Vendor"` to grant access to the "SIS-Vendor" claimset.

Using the OAuth concept of _scope_ opens the future possibility of using three-legged OAuth and allowing the client to request a claimset by using the Scope parameter in their initial token request.

The DMS thus must lookup the details of the claimset, since those details are not included in the token. Furthermore, the OAuth Identity Provider (IdP) will not store this information; the DMS will need to pull this information from the DMS Configuration Service, as described in a section below.

> ![NOTE]
> Claimset names in the ODS/API Platform often have spaces in them. These spaces will be
> replaced with a short dash `-` for DMS, since space is used as a separator for multiple
> scopes in a JWT.

### Namespaces

Technically a given client can have an unlimited number of namespaces. In practice, we anticipate that there will usually be one to three namespaces. Thus the namespaces can be stored directly on the JWT generated by the IdP.

### Education Organization Identifiers

In some rare cases a client may have access to a large number of education organizations. For example, a Student Information System (SIS) that provides service to half of the school districts in Texas might have a single client that has access to 600 local education organizations. Storing all of those in the JWT is probably excessive.

Design for handling this is _to be determined_.

## Authorization and Dependency Ordering

The dependencies endpoint in the Discovery API will likely be influenced by
authorization requirements. For example, in the ODS/API's _education
organization_ based authorization, the Student _create_ permission has a higher
order number for the Student _update_ permission, with the Student School
Association coming in between the two. This is because the Student cannot be
updated until there is a Student School Association with which to decide if the
update is authorized.

## Namespace based authorization on DMS

### 1. Authenticating and Authorizing the Client on DMS

The client provides its client ID and secret to the oauth/token endpoint on DMS.
The system then authenticates these credentials using a third-party
authentication provider(`Keycloak`), which returns a token upon successful
authentication.
> [!NOTE]
> For more details on configuring the DMS client and token information, please refer to [Configure client on Keycloak](https://github.com/Ed-Fi-Alliance-OSS/Data-Management-Service/blob/DMS-81/eng/docker-compose/KEYCLOAK-SETUP.md)

### 2. Token Validator and Interpreter

The provided token will be validated to ensure it includes the expected role,
such as 'dms-client.' Then, the token interpreter will decode the token to
extract essential authorization metadata, including the Client ID, ClaimSet
name, Education Organization IDs, Namespace prefixes, and other relevant
details.

### 3. Authorization Context

An authorization context is established, including the client's basic
authorization details (Client id, Claim set name, Education Organization ids,
Namespace prefixes etc..). This context data is then cached to streamline
further requests.

### 4. Security Metadata Cache

> [!NOTE]
> The initial implementation may not need to validate or account for hierarchy
> or grouping based authorization.

Caching only the claim set data may be insufficient, as parent entity details
could also be required for authorization. On DMS, the claim set
details—including resource claims, resource claim actions, and resource claim
action authorization strategies—are retrieved and cached from the DMS
Configuration Service, which stores this data in its own database.

### 5. Authorizing /data Endpoint Requests

Authorization checks for the /data endpoint requests are performed immediately
before database operations (CRUD operations).

### 6. Authorization Middleware

Within the authorization middleware, the system decides whether the request is
authorized or not.

### 7. Security Backend

A dedicated project is in place to handle all authorization processes.

### 8. Initial Implementation

The initial plugin structure (Interfaces and classes) will be established to
support the process of verifying the request against the claim set.

Handlers will be created for two authorization strategies:

* Namespace-based Authorization

* No Further Authorization

#### Resources and Descriptors authorization

**Resources:** Initially, resource operations will use the "No Further
Authorization" strategy.

**Descriptors:** Create, update, and delete operations for descriptors will
require "Namespace Based" authorization, while read operations require "No
Further Authorization".

```mermaid
---
title: Cache basic authorization details
---
flowchart TB
a1<--token-->k1
subgraph Keycloak
    k1[Token provider]
end
 subgraph DMS
    a1[Token endpoint]-->a2[Token Interpreter]
    a2-->a3[Retrieve the Client ID, Claim Set, Namespace Prefixes, and EdOrg IDs, then cache them within the API client context]
    end
 subgraph Client
    oauth/token-->a1
    end
```

## Proposed Application Design

```mermaid
---
title: Authorization flow
---
flowchart TD
 subgraph DMS
        a1[Authorization Middleware] --> a2[Retrieve claims from JWT]
        a2 --> a2_2[Lookup ClaimSet information]
        a2_2 --> a3[Compare Incoming Resource and Action, and Retrieve Auth Strategy]
        a3 --> a4[Direct to Appropriate Auth Strategy Handler]
        a4 --> a5{Is Request Authorized?}
        a5 --YES--> a6[Proceed with CRUD operation]
        a5 --NO--> a7[Return an appropriate error response]
    end

    subgraph Client
        data[Request to /data/ed-fi/students] --> a1
    end
```
